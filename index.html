<!DOCTYPE html>
<html lang="pl_PL">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Bin Operations</title>

	<!-- Bootstrap -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
			<![endif]-->
		</head>
		<body>

			<div class="container">
				<div class="row">
					<div class="col-md-6">
						<input class="btn btn-primary form-control" type="text" name="base10" id="base10"  size="18" oninput="convert()">
					</div>
					<div class="col-md-6">
						<input type="text" class="btn btn-primary form-control" name="base102" id="base102"  size="18" oninput="convert()">
					</div>
				</div>
				<div class="row">
					<div class="col-md-5">
						<input type="text" class="btn btn-default form-control col-md-6" name="base2" id="base2"  size="16" oninput="convert()" maxlength="10" disabled>
					</div>
					<div class="col-md-2 operation">
						<button id="+" class="col-md-4">+</button>
						<button id="-" class="col-md-4">-</button>
						<button id="*" class="col-md-4">*</button>
					</div>
					<div class="col-md-5">
						<input type="text" class="btn btn-default form-control col-md-6" name="base22" id="base22"  size="16" oninput="convert()" disabled>
					</div>
				</div>
				<div class="row">
					<div class="col-md-12">
						<label class="btn btn-success form-control" type="text" id="dec_wynik" disabled></label>
					</div>
					<div class="col-md-12">
						<label class="btn btn-success form-control" type="text" id="bin_wynik" disabled></label>
					</div>
				</div>
			</div>


			<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
			<script src="js/jquery.js"></script>
			<!-- Include all compiled plugins (below), or include individual files as needed -->
			<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

			<script>

				document.getElementById("base10").value = "11";
				document.getElementById("base102").value = "11";
				convert();

				var bin1;
				var bin2;
				var dec1;
				var dec2;

				function convert(){
					dec1 = parseFloat(document.getElementById("base10").value);
					dec2 = parseFloat(document.getElementById("base102").value);
					if(dec1<0){
						bin1 = dec2Bin(dec1).substring(1);
					} else {
						bin1 = dec2Bin(dec1);
					}
					if(dec2<0){
						bin2 = dec2Bin(dec2).substring(1);
					} else {
						bin2 = dec2Bin(dec2);
					}

					document.getElementById("base2").value = dec2Bin(dec1);
					document.getElementById("base22").value = dec2Bin(dec2);
				}

				function checkSign(first, second, operation){
					first = parseFloat(first);
					second = parseFloat(second);
					var Binaries = normalize(bin1,bin2);

					var sign; 
					var u2;

					if(operation=="-"){
						second = (-1)*second;
					}

					if(first<0){
						Binaries.first = toFromU2(Binaries.first);
						console.log("pierwsza",Binaries.first)
						u2=true;
					}
					if(second<0){
						Binaries.second= toFromU2(Binaries.second);
						console.log("druga", Binaries.second)
						u2=true;
					}
					console.log(second);
					if(first >= 0 && second >= 0 && (operation=="+" || operation=="*" || operation=="-")){	
						sign = true;
					} else if (first < 0 && second < 0 && (operation=="+" || operation=="*")) {
						if(operation=="*")
							sign=true;
						if(operation=="+")
							sign=false;
					} else if(first >= 0 && second < 0 && (operation=="+" || operation=="*")){
						if(operation=="*")
							sign=false;
						if(operation=="+"){
							if(Math.abs(second)>first){
								sign = false;
							} else {
								sign = true;
							}
						}
					} else if(first < 0 && second >= 0 && (operation=="+" || operation=="*")){
						if(operation=="*")
							sign=false;
						if(operation=="+"){
							if(Math.abs(first)>second){
								sign = false;
							} else {
								sign = true;
							}
						}
					}

					return { sign: sign, binaries: Binaries, isU2: u2};
				}

				function addition(Binaries){
					var sign = Binaries.sign;
					var isU2 = Binaries.isU2;
					Binaries = Binaries.binaries;

					var score = "";
					var memory = [];

					for (var i = 0; i < Binaries.size+1; i++) {
						memory[i]="0";		
					};

					for (var i = Binaries.size-1; i >= 0; i--) {
						if(Binaries.first[i]=="."){
							score = "."+score;
							continue;
						}
						if((Binaries.first[i]=="1" && Binaries.second[i]=="1")){
							memory[i]="1";
							score = "0"+score;
						} else if((Binaries.first[i]=="1" && Binaries.second[i]=="0")||(Binaries.first[i]=="0" && Binaries.second[i]=="1")){
							score = "1"+score;
						} else if(Binaries.first[i]=="0" && Binaries.second[i]=="0"){
							score = "0"+score;
						}

						if(memory[i+1]=="1"){
							if(score[0]=="0"){
								score = "1"+score.substring(1);
							} else {
								score = "0"+score.substring(1);
								memory[i]="1";
							}
						}
					};
					if(!isU2)
					if(memory[0]=="1"){
						score = "1"+score;
					}
					if(sign==false){
						score = toFromU2(score);
					} 

					return score.toString(2);
				}


				function multiplication(Binaries){
					var sign = Binaries.sign;
					var isU2 = Binaries.isU2;
					Binaries = Binaries.binaries;
					console.log(sign);
					var memory = [];
					var counter = 0;

					for (var i = Binaries.size-1; i >= 0; i--) {
					var score = "";
						for (var j = Binaries.size-1; j >= 0; j--) {
							if(Binaries)
							if(Binaries.second[i] == 1 && Binaries.first[j] == 1){
								score = "1"+score;
							} else {
								score = "0"+score;
							}
						};
						memory[counter]=(score+genZeros(counter));
						counter++;


					};
					for (var i = 0; i < memory.length-1; i++) {
						var Bin = {sign: true, binaries: normalize(memory[i],memory[i+1]), isU2: isU2};
							memory[i+1] = addition(Bin);

					};

					return memory[memory.length-1].toString(2);
				}

				function dec2Bin(dec){
					if(dec >= 0) {
						return dec.toString(2).substring(0,15);
					} else {
						return "-"+(Math.abs(dec)).toString(2).substring(0,15);
					}
				}

				function normalize(first, second){
					var tmp1 = first.toString(2);
					var tmp2 = second.toString(2);

					var size;
					var numZero1 = tmp1.length - tmp1.indexOf(".");
					var numZero2 = tmp2.length - tmp2.indexOf(".");

					if(tmp1.indexOf(".")>-1){
						if(tmp2.indexOf(".")>-1){
							if(numZero1>=numZero2){
								tmp2 += genZeros(numZero1-numZero2);
							} else {
								tmp1 += genZeros(numZero2-numZero1);
							}
						} else {
							tmp2 += "."+genZeros(numZero1-1);
						}
					} else {
						if(tmp2.indexOf(".")>-1){
							tmp1 += "."+genZeros(numZero2-1);
						}

					}
					if(tmp1.length>=tmp2.length){
						size = tmp1.length;
						var zerosN = Math.abs(tmp1.length-tmp2.length);
						for (var i = 0; i < zerosN; i++) {
							tmp2 = "0"+tmp2;
						};
					} else {
						size = tmp2.length;
						var zerosN = Math.abs(tmp1.length-tmp2.length);
						for (var i = 0; i < zerosN; i++) {
							tmp1 = "0"+tmp1;
						};
					}
					var Binaries = { size: size, first: tmp1, second: tmp2 };
					console.log("Po normalizacji", Binaries);
					return Binaries;
				}

				function toFromU2(bin){
					console.log("w u2",bin)
					var bin_u2="";
					for (var i = 0; i < bin.length; i++) {
						if(bin[i]=="1"){
							bin_u2+="0";
						} else if(bin[i]=="0"){
							bin_u2+="1";
						} else {
							bin_u2 += bin[i];
						}
					};
					var Binaries = normalize(bin_u2,"1");
					Binaries = {sign: true, binaries: Binaries};
					return addition(Binaries);
				}

				function binReverse(array){
					var tmp = [];

					for (var i = 0; i < array.length; i++) {
						tmp[array.length-1-i] = array[i];
					};

					return tmp.join("");
				}

				function toOnePlus(number){
					var point_pos = number.indexOf(".")+1;
					var first_one = number.indexOf("1")+1;

					var exp = point_pos-first_one;

					if(exp>=0){
						exp--;
					} else {
						first_one--;
					}

					var op_number = "1."+number.replace(".","").substring(first_one);
					op_number = { "val": op_number, "exp": exp};
					return op_number;
				}

				function toFloatingPointNumber(number, sign){
					number = number.toString();
					var op_number = toOnePlus(number);
					var bias = 15.0;
					var exp = binReverse(dec2Bin(parseFloat(op_number.exp)+bias).toString().substring(0,5));

					var fp_number = genZeros(16);

					//Dodanie bitu znaku
					if(sign){
						sign = "0";
					} else {
						sign = "1";
					}

					fp_number = sign+ genZeros(5-exp.length)+binReverse(exp) + op_number.val.substring(2) + genZeros(10-op_number.val.length+2);
					return fp_number;
				}
				
				function genZeros(number){
					var tmp = "";
					for (var i = 0; i < number; i++) {
						tmp += '0';
					};
					return tmp;
				}



				$(function(){
					$( ".operation button" ).click(function () {
						var selected = $(this).attr("id");
						var Binaries = checkSign(dec1,dec2,selected);
						var score_bin;
						switch(selected){
							case '+':
							score_bin = addition(Binaries);
							break;
							case '-':
							score_bin = addition(Binaries);
							break;
							case '*':
							score_bin = multiplication(Binaries);
							break;
						}
						$("#bin_wynik").text(toFloatingPointNumber(score_bin, Binaries.sign));
						$("#dec_wynik").text(parseFloat(score_bin));

					});

				});
			</script>

		</body>

		</html>
